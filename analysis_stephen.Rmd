---
title: "Analysis of Mojave Mean Annual Soil Temperature (tempC) Dataset"
author: "Stephen Roecker"
date: "2014"
output: 
  html_document: 
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: no
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE, cache = TRUE)

# load packages
suppressWarnings( {
  library(sp)
  library(raster)
  library(ggplot2)
  library(caret)
  })

```


# Read tempC data

```{r}

setwd("D:/projects/soilTemperatureMonitoring/data/R")

sites_df <- read.csv("HOBO_List_2013_0923_master.csv")
mast_df  <- read.csv("mastSites.csv")

mast_df <- merge(mast_df, sites_df, by = "siteid")
vars <- c("siteid", "tempF", "numDays", "utmeasting", "utmnorthing")
mast_df <- mast_df[vars]
mast_df$tempC <- (mast_df$tempF - 32) * (5 / 9)

mast_sp <- mast_df
coordinates(mast_sp) <- ~ utmeasting + utmnorthing
proj4string(mast_sp)<- ("+init=epsg:26911")
mast_sp <- spTransform(mast_sp, CRS("+init=epsg:5070"))

```


# Read geodata

```{r}

folder <- "D:/geodata/project_data/R8-VIC/"
files <- c(elev   = "ned30m_8VIC_elev5.tif",
           solar  = "ned30m_8VIC_solarcv.tif",
           tc     = "landsat30m_8VIC_tc123.tif",
           precip = "prism30m_8VIC_ppt_1981_2010_annual_mm.tif",
           temp   = "prism30m_8VIC_tmean_1981_2010_annual_C.tif"
           )
geodata_f <- lapply(files, function(x) paste0(folder, x))
geodata_r <- stack(geodata_f)
data <- as.data.frame(extract(geodata_r, mast_sp, sp = TRUE))

```


# Exploratory Data Analysis

```{r}

# Summary of tempC data
ggplot(data, aes(sample = tempC)) +
  geom_qq() +
  geom_qq_line()

vars <- c("tempC", names(geodata_r))
GGally::ggpairs(data[, vars])

# Compare environmental representativeness of hobo locations 
geodata_s <- as.data.frame(sampleRegular(geodata_r, size = 5000))

geodata_s <- rbind(
  data.frame(source = "sample", data[names(geodata_r)]),
  data.frame(source = "population", geodata_s)
)

geodata_s <- reshape(geodata_s,
                     direction = "long",
                     timevar = "variable", times = names(geodata_r),
                     v.names = "value",  varying = names(geodata_r) 
                     )
ggplot(geodata_s, aes(x = value, fill = source)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~ variable, scales = "free") +
  ggtitle("Evaluation of Sample Representativeness")

```


# Construct Linear Model

```{r}
# Estimate tempC model
full <- lm(tempC ~ .,data = data, weights = numDays)
mast_lm <- lm(tempC ~ temp + solar + precip + tc_1, data = data, weights = numDays)

plot(data$tempC ~ predict(mast_lm),
     ylab = "Observed tempC",
     xlab = "Predicted tempC",
     main = "Observed vs. predicted tempC")
abline(0,1)


# Validate tempC model
# Create folds
folds <- createFolds(data$tempC, k = 10)
train <- data

# Cross validate
cv_results <- lapply(folds, function(x) {
  train   = train[-x,]
  test    = train[x,]
  model   = lm(tempC ~ temp + solar + precip + tc_1, weights = numDays, data = train)
  actual  = test$tempC
  predict = predict(model, test)
  RMSE    = sqrt(mean((actual - predict)^2, na.rm = TRUE))
  R2      = cor(actual, predict, use = "pairwise")^2
  return(c(RMSE = RMSE, R2 = R2))
  })

# Convert to a data.frame
cv_results <- do.call(rbind, cv_results)

# Summarize results
summary(cv_results)

```


```{r, eval=FALSE}

# Predict tempC model
predfun <- function(model, data) {
  v <- predict(model, data, se.fit=TRUE)
}
mast.raster <- predict(geodata, mast.lm, fun=predfun, index=1:2, progress='text')
writeRaster(mast.raster[[1]],filename="I:/workspace/soilTemperatureMonitoring/R/mast.raster.new.tif",format="GTiff",datatype="INT1S",overwrite=T,NAflag=-127, options=c("COMPRESS=DEFLATE", "TILED=YES"), progress='text')
test <- raster(mast.raster,layer=2)
writeRaster(test,filename="I:/workspace/soilTemperatureMonitoring/R/mast.se.raster.new.tif",format="GTiff",datatype="INT1S",overwrite=T,NAflag=-127, options=c("COMPRESS=DEFLATE", "TILED=YES"), progress='text')

```
